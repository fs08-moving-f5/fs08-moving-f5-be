// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String   @id @default(uuid())
  providerId String?
  provider   String   @default("local")
  type       UserType @default(USER)

  name     String
  email    String  @unique
  password String?
  phone    String?

  refreshTokens String?

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProfile                UserProfile?
  driverProfile              DriverProfile?
  estimateRequest            EstimateRequest[]
  estimates                  Estimate[]
  notifications              Notification[]
  favoriteDrivers            FavoriteDriver[]  @relation("DriverFavorites")
  favoritedBy                FavoriteDriver[]  @relation("UserFavorites")
  reviews                    Review[]
  designatedEstimateRequests EstimateRequest[] @relation("DesignatedEstimateRequests")
}

enum UserType {
  USER
  DRIVER
  ADMIN
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  imageUrl String?
  regions  RegionEnum[]
  services ServiceEnum[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverProfile {
  id       String @id @default(uuid())
  driverId String @unique
  driver   User   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  imageUrl    String?
  career      Int?
  shortIntro  String?
  description String?
  regions     RegionEnum[]
  services    ServiceEnum[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RegionEnum {
  서울
  경기
  인천
  강원
  충북
  충남
  대전
  세종
  전북
  전남
  광주
  경북
  경남
  대구
  부산
  울산
  제주
}

enum ServiceEnum {
  SMALL_MOVING
  HOME_MOVING
  OFFICE_MOVING
}

model EstimateRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  movingType ServiceEnum
  movingDate DateTime
  status     EstimateStatus @default(PENDING)

  isDesignated       Boolean @default(false)
  designatedDriverId String?
  designatedDriver   User?   @relation("DesignatedEstimateRequests", fields: [designatedDriverId], references: [id], onDelete: SetNull)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estimate  Estimate[]
  addresses Address[]

  @@index([status, isDelete, movingType, createdAt]) // 무한 스크롤 + 필터(상태, 삭제 여부, 서비스 유형, 생성일일)
  @@index([status, isDelete, movingDate]) // 정렬용(이사 빠른/느린순순)
  @@index([createdAt, id]) // cursor 안정성 보강
  @@index([userId, isDelete, createdAt]) //userId 기준 조회(마이페이지 / 히스토리용)
}

enum EstimateStatus {
  PENDING // 대기 중
  CONFIRMED // 확정
  REJECTED // 거절
  CANCELLED // 취소
}

model Estimate {
  id                String          @id @default(uuid())
  estimateRequestId String
  estimateRequest   EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)

  driverId String
  driver   User   @relation(fields: [driverId], references: [id])

  price        Int?
  comment      String?
  rejectReason String?
  status       EstimateStatus @default(PENDING)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  review Review?

  @@unique([estimateRequestId, driverId])
  @@index([driverId, isDelete, createdAt]) // 기사 기준 조회
}

model Address {
  id                String          @id @default(uuid())
  estimateRequestId String
  estimateRequest   EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)

  addressType    AddressType
  zoneCode       String
  address        String
  addressEnglish String
  sido           String
  sidoEnglish    String
  sigungu        String
  sigunguEnglish String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([estimateRequestId, addressType]) //form, to 구분 활용
  @@index([sido]) // 지역 필터(풀스캔 방지)
  @@index([estimateRequestId]) //JOIN 최적화
}

enum AddressType {
  FROM
  TO
}

model Review {
  id         String   @id @default(uuid())
  estimateId String   @unique
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  rating  Int?
  content String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model FavoriteDriver {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)

  driverId String
  driver   User   @relation("DriverFavorites", fields: [driverId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, driverId])
}

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     NotificationType
  message  String
  datajson Json?
  isRead   Boolean          @default(false)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isRead, isDelete, createdAt]) // 알림 목록, 안 읽은 수 최신순 정렬
}

enum NotificationType {
  REQUEST_SENT // 유저가 견적 요청을 보냄
  REQUEST_REJECTED // 유저가 견적을 거절
  REQUEST_CANCELLED // 유저가 견적 요청을 취소

  ESTIMATE_RECEIVED // 기사가 견적을 작성하여 유저에게 도착
  ESTIMATE_CONFIRMED // 유저가 견적서를 보고 견적 확정
  ESTIMATE_REJECTED // 기사가 요청을 거절(반려 사유)
  ESTIMATE_EXPIRED // 견적 시간 만료

  NEW_REVIEW // 새 리뷰 등록
  FAVORITE_ADDED // 기사 찜하기

  SYSTEM_NOTICE // 시스템 알림(점검/유지보수 등)
  PROMOTION // 프로모션, 이벤트
}

model History {
  id String @id @default(uuid())

  actionType String?
  actionDesc String?

  entityType String?
  entityId   String?

  previousData Json?
  newData      Json?

  createdAt DateTime @default(now())

  @@index([createdAt]) // 감사 로그 최신순 정렬
  @@index([entityType, entityId, createdAt]) // 대상 엔티티 기준
  @@index([actionType, createdAt]) // 이벤트 기준
}

model DriverStatusView {
  driverId               String @id @map("driverId")
  career                 Int?
  reviewCount            Int    @map("review_count")
  averageRating          Float  @map("average_rating")
  confirmedEstimateCount Int    @map("confirmed_estimate_count")
  favoriteDriverCount    Int    @map("favorite_driver_count")

  @@map("DriverStatusView")
}
