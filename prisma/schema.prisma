generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  providerId String?
  provider   String   @default("local")
  type       UserType @default(USER)

  name     String
  email    String  @unique
  password String?
  phone    String?

  refreshTokens String?

  isEmailVerified Boolean @default(false)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProfile                UserProfile?
  driverProfile              DriverProfile?
  estimates                  Estimate[]
  designatedEstimateRequests EstimateRequest[] @relation("DesignatedEstimateRequests")
  estimateRequest            EstimateRequest[]
  favoriteDrivers            FavoriteDriver[]  @relation("DriverFavorites")
  favoritedBy                FavoriteDriver[]  @relation("UserFavorites")
  notifications              Notification[]
  reviews                    Review[]
}

model UserProfile {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  imageUrl String?
  regions  RegionEnum[]
  services ServiceEnum[]

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverProfile {
  id String @id @default(uuid())

  driver   User   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  driverId String @unique

  imageUrl    String?
  career      Int?
  shortIntro  String?
  description String?
  regions     RegionEnum[]
  services    ServiceEnum[]

  officeAddress   String?
  officeLat       Float?
  officeLng       Float?
  officeSido      String?
  officeSigungu   String?
  officeUpdatedAt DateTime?
  officeZoneCode  String?

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([career])
  @@index([officeLat, officeLng])
}

model EstimateRequest {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  movingType         ServiceEnum
  movingDate         DateTime
  status             EstimateStatus @default(PENDING)
  isDesignated       Boolean        @default(false)
  designatedDriverId String?

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  designatedDriver User?      @relation("DesignatedEstimateRequests", fields: [designatedDriverId], references: [id])
  addresses        Address[]
  estimate         Estimate[]

  @@index([movingType, createdAt])
  @@index([movingDate])
  @@index([createdAt, id])
  @@index([userId, createdAt])
  @@index([isDesignated, designatedDriverId])
}

model Estimate {
  id String @id @default(uuid())

  estimateRequest   EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)
  estimateRequestId String
  driver            User            @relation(fields: [driverId], references: [id])
  driverId          String

  price        Int?
  comment      String?
  rejectReason String?
  status       EstimateStatus @default(PENDING)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  review Review?

  @@unique([estimateRequestId, driverId])
  @@index([driverId, createdAt])
  @@index([estimateRequestId])
}

model Address {
  id String @id @default(uuid())

  estimateRequest   EstimateRequest @relation(fields: [estimateRequestId], references: [id], onDelete: Cascade)
  estimateRequestId String

  addressType    AddressType
  zoneCode       String
  address        String
  addressEnglish String
  sido           String
  sidoEnglish    String
  sigungu        String
  sigunguEnglish String

  lat Float?
  lng Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([estimateRequestId, addressType])
  @@index([sido, estimateRequestId])
  @@index([lat, lng])
}

model Review {
  id String @id @default(uuid())

  estimate   Estimate @relation(fields: [estimateId], references: [id])
  estimateId String   @unique
  user       User     @relation(fields: [userId], references: [id])
  userId     String

  rating  Int?
  content String?

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model FavoriteDriver {
  id String @id @default(uuid())

  user     User   @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  driver   User   @relation("DriverFavorites", fields: [driverId], references: [id], onDelete: Cascade)
  driverId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, driverId])
  @@index([userId, createdAt])
  @@index([driverId, createdAt])
}

model Notification {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  type     NotificationType
  message  String
  datajson Json?
  isRead   Boolean          @default(false)

  isDelete  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isRead, isDelete, createdAt])
}

model History {
  id String @id @default(uuid())

  actionType   String?
  entityType   String?
  entityId     String?
  previousData Json?
  newData      Json?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([actionType, createdAt])
}

model DriverStatusView {
  driverId               String @id @map("driverId")
  career                 Int?
  reviewCount            Int    @map("review_count")
  averageRating          Float  @map("average_rating")
  confirmedEstimateCount Int    @map("confirmed_estimate_count")
  favoriteDriverCount    Int    @map("favorite_driver_count")

  @@map("DriverStatusView")
}

enum UserType {
  USER
  DRIVER
  ADMIN
}

enum RegionEnum {
  서울
  경기
  인천
  강원
  충북
  충남
  대전
  세종
  전북
  전남
  광주
  경북
  경남
  대구
  부산
  울산
  제주
}

enum ServiceEnum {
  SMALL_MOVING
  HOME_MOVING
  OFFICE_MOVING
}

enum EstimateStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
}

enum AddressType {
  FROM
  TO
}

enum NotificationType {
  REQUEST_SENT
  REQUEST_REJECTED
  REQUEST_CANCELLED
  ESTIMATE_RECEIVED
  ESTIMATE_CONFIRMED
  ESTIMATE_REJECTED
  ESTIMATE_EXPIRED
  NEW_REVIEW
  FAVORITE_ADDED
  SYSTEM_NOTICE
  PROMOTION
}
